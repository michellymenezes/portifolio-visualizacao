---
title: "Fluxo na sociedade"
date: 2017-12-05T09:34:30-03:00
tags: [D3, Heatmap]
draft: false
---

<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8">
  <title>Fluxo na sociedade</title>
  <script src="https://d3js.org/d3.v2.js"></script>

  <script src="https://d3js.org/d3.v4.min.js"></script>
</head>

<body>
  <div class="container">
    <div class="row">
      <h1>O que o fluxo da mobilidade pode nos contar sobre a sociedade?</h1>
      <h2>Chart 1</h2>
    </div>

    <div class="row mychart1" id="chart1">

    </div>
    <h2>Chart 2</h2>
    <div class="chart2" id="chart2">

    </div>

  </div>

  <style>

    .mychart1 rect.bordered {
      stroke: #E6E6E6;
      stroke-width:2px;
    }

    .mychart1 text.mono {
      font-size: 9pt;
      font-family: Consolas, courier;
      fill: #818080;
    }

    .mychart1 text.axis-grupo {
      fill: #818080;
    }

    .mychart1 text.axis-horas {
      fill: #818080;
    }


    .chart2 {
      font: 10px sans-serif;
      font-family: Consolas, courier;
    }

    p {
      font: 12px helvetica;
      font-family: Consolas, courier;
    }

    .axis path, .axis line {
      fill: none;
      stroke: #818080;
      stroke-width: 2px;
      shape-rendering: crispEdges;
    }

  </style>

  <script type="text/javascript">
    "use strict"


      function onlyUnique(value, index, self) {
          return self.indexOf(value) === index;
      }

      function tipoToNum(tipo) {
        if (tipo === "carros") return 0;
        if (tipo === "motos") return 1;
        if (tipo === "caminhoes") return 2;
        if (tipo === "onibus") return 3;
        if (tipo === "total_ciclistas") return 4;
        return 5;
      }

      function pickColor(colors, n, tipo){
        n = Math.floor(n/205*9);
        return colors[n]
      }
      // Preencha aqui.

      var alturaSVG = 400, larguraSVG = 600;
      var	margin = {top: 50, right: 40, bottom:100, left:80}, // para descolar a vis das bordas do grafico
          larguraVis = larguraSVG - margin.left - margin.right,
          alturaVis = alturaSVG - margin.top - margin.bottom,
          gridSize = Math.floor(larguraVis / 15),
          legendElementWidth = Math.floor(larguraVis / 9),
          buckets = 9,
          colors = ["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"]; // alternatively colorbrewer.YlGnBu[9];

      /*
       * Prepara onde adicionaremos a visualizacao
       */

      var grafico = d3.select('#chart1') // cria elemento <svg> com um <g> dentro
        .append('svg')
          .attr('width', larguraVis + margin.left + margin.right)
          .attr('height', alturaVis + margin.top + margin.bottom)
        .append('g') // para entender o <g> vá em x03-detalhes-svg.html
          .attr('transform', 'translate(' +  margin.left + ',' + margin.top + ')');

      var grupoLabels = grafico.selectAll(".grupoLabel")
          .data(["Carros", "Motos", "Caminhoes", "Onibus", "Ciclistas", "Pedestres"])
          .enter().append("text")
            .text(function (d) { return d; })
            .attr("x", 0)
            .attr("y", function (d, i) { return i * gridSize; })
            .style("text-anchor", "end")
            .attr("transform", "translate(-6," + gridSize / 1.5 + ")")
            .attr("class", function (d, i) { return "grupoLabel mono axis axis-grupo"; });

      var timeLabels = grafico.selectAll(".timeLabel")
                .data([6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20])
                .enter().append("text")
                  .text(function(d) { return d; })
                  .attr("x", function(d, i) { return i * gridSize; })
                  .attr("y", 0)
                  .style("text-anchor", "middle")
                  .attr("transform", "translate(" + gridSize / 2 + ", -6)")
                  .attr("class", function(d, i) { return "timeLabel mono axis"; });


      var heatmapChart = function() {
        d3.csv("https://raw.githubusercontent.com/michellymenezes/portifolio-visualizacao/master/data/tipos-fluxo-campina-median.csv",

        function(error, dados) {
          // var colorScale = d3.scaleQuantile()
          //     .domain([0, buckets - 1, d3.max(dados, function (d) { return d.n; })])
          //     .range(colors);

          var colorScale = d3.scaleThreshold()
              .domain([0, 10, 30, 70, 100, 120, 150, 170, 190])
              .range([0].concat(colors));

          var cards = grafico.selectAll(".hour")
              .data(dados);

          cards.append("title");

          cards.enter().append("rect")
              .attr("x", function(d) { return (d.hora - 6) * gridSize; })
              .attr("y", function(d) { return (tipoToNum(d.tipo)) * gridSize; })
              .attr("rx", 4)
              .attr("ry", 4)
              .attr("class", "hour bordered")
              .attr("width", gridSize)
              .attr("height", gridSize)
              .style("fill", function(d) { return pickColor(colors, d.n, d.tipo)});


          var legend = grafico.selectAll(".legend")
              .data(colorScale.domain(), function(d) { return d; })
              .enter().append("g")
              .attr("class", "legend");

          legend.append("rect")
            .attr("x", function(d, i) { return legendElementWidth * i; })
            .attr("y", alturaVis)
            .attr("width", legendElementWidth)
            .attr("height", gridSize / 2)
            .style("fill", function(d, i) { return colors[i]; });

          legend.append("text")
            .attr("class", "mono")
            .text(function(d) { return "≥ " + Math.round(d); })
            .attr("x", function(d, i) { return legendElementWidth * i; })
            .attr("y", alturaVis + gridSize);
        });
      };

      heatmapChart();








      chart("https://raw.githubusercontent.com/michellymenezes/portifolio-visualizacao/master/data/tipos-motor-fluxo-campina-median0.csv", "orange");

      var datearray = [];
      var colorrange = [];


      function chart(csvpath, color) {

        if (color == "blue") {
          colorrange = ["#045A8D", "#2B8CBE", "#74A9CF", "#A6BDDB", "#D0D1E6", "#F1EEF6"];
        }
        else if (color == "pink") {
          colorrange = ["#980043", "#DD1C77", "#DF65B0", "#C994C7", "#D4B9DA", "#F1EEF6"];
        }
        else if (color == "orange") {
          colorrange = ["#B30000", "#E34A33", "#FC8D59", "#FDBB84", "#FDD49E", "#FEF0D9"];
        }
        var strokecolor = colorrange[0];

        var format = d3.time.format("%H:%M");

        var margin = {top: 20, right: 40, bottom: 30, left: 30};
        //var width = 600- margin.left - margin.right;
        //var height = 300 - margin.top - margin.bottom;
        var width = larguraVis;
        var height = alturaVis;

        var tooltip = d3.select(".chart2")
            .append("div")
            .attr("class", "remove")
            .style("position", "absolute")
            .style("z-index", "20")
            .style("visibility", "hidden")
            .style("top", height*4 + "px")
            .style("left", width + "px");

        var x = d3.time.scale()
            .range([0, width]);

        var y = d3.scale.linear()
            .range([height-10, 0]);

        var z = d3.scale.ordinal()
            .range(colorrange);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom")
            .ticks(d3.time.hours);
        var yAxis = d3.svg.axis()
            .scale(y);

        var yAxisr = d3.svg.axis()
            .scale(y);

        var stack = d3.layout.stack()
            .offset("silhouette")
            .values(function(d) { return d.values; })
            .x(function(d) { return d.date; })
            .y(function(d) { return d.value; });

        var nest = d3.nest()
            .key(function(d) { return d.key; });

        var area = d3.svg.area()
            .interpolate("cardinal")
            .x(function(d) { return x(d.date); })
            .y0(function(d) { return y(d.y0); })
            .y1(function(d) { return y(d.y0 + d.y); });

        var svg = d3.select(".chart2").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var graph = d3.csv(csvpath, function(data) {
          data.forEach(function(d) {
            d.date = format.parse(d.date);
            d.value = +d.value;
          });

          var layers = stack(nest.entries(data));

          x.domain(d3.extent(data, function(d) { return d.date; }));
          y.domain([0, d3.max(data, function(d) { return d.y0 + d.y; })]);

          svg.selectAll(".layer")
              .data(layers)
              .enter().append("path")
              .attr("class", "layer")
              .attr("d", function(d) { return area(d.values); })
              .style("fill", function(d, i) { return z(i); });
            var  formatTime = d3.time.format("%H:%M")

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0, " + height + ")")
              .call(d3.axisBottom(
                d3.scaleLinear()
                  .domain([6, 20.75])
                  .rangeRound([0, larguraVis]) // Configure essa escala com domain, range e padding

              ));

          svg.append("g")
              .attr("class", "y axis")
              .attr("transform", "translate(" + width + ", 0)")
              .call(d3.axisRight(
                d3.scaleLinear()
                  .domain([305, 0])
                  .rangeRound([0, alturaVis]) // Configure essa escala com domain, range e padding

              ));

          svg.append("g")
              .attr("class", "y axis")
              .call(d3.axisLeft(
                d3.scaleLinear()
                  .domain([305, 0])
                  .rangeRound([0, alturaVis]) // Configure essa escala com domain, range e padding

              ));
  var pro = 0
          svg.selectAll(".layer")
            .attr("opacity", 1)
            .on("mouseover", function(d, i) {
              svg.selectAll(".layer").transition()
              .duration(250)
              .attr("opacity", function(d, j) {
                return j != i ? 0.6 : 1;
            })})

            .on("mousemove", function(d, i) {
              var mousex = d3.mouse(this);
              mousex = mousex[0];
              var invertedx = [x.invert(mousex)].map(formatTime)[0];
        //      console.log(invertedx);
        //      invertedx = invertedx.getTime();
              if(invertedx.substring(3,5) == "00" || invertedx.substring(3,5) == "15" || invertedx.substring(3,5) == "30" || invertedx.substring(3,5) == "45"){
              var selected = (d.values);
              for (var k = 0; k < selected.length; k++) {

              //  console.log([selected[k].date].map(formatTime)
            //  );
                datearray[k] = [selected[k].date].map(formatTime)[0]
        //            datearray[k] = datearray[k].getTime();;
              }
              var mousedate = datearray.indexOf(invertedx);
              console.log(datearray);
              console.log(datearray.indexOf(invertedx));
              console.log(invertedx);

              pro = d.values[mousedate].value;

              d3.select(this)
              .classed("hover", true)
              .attr("stroke", strokecolor)
              .attr("stroke-width", "0.5px"),
              tooltip.html( "<p>" + d.key + "<br>" + pro + "</p>" ).style("visibility", "visible");
        }
            })
            .on("mouseout", function(d, i) {
             svg.selectAll(".layer")
              .transition()
              .duration(250)
              .attr("opacity", "1");
              d3.select(this)
              .classed("hover", false)
              .attr("stroke-width", "0px"), tooltip.html( "<p>" + d.key + "<br>" + pro + "</p>" ).style("visibility", "hidden");
          })
          console.log(height);
          var vertical = d3.select(".chart2")
                .append("div")
                .attr("class", "remove")
                .style("position", "absolute")
                .style("z-index", "19")
                .style("width", "1px")
                .style("height", height+"px")
                .style("top", height * 4 + "px")
                .style("bottom", -alturaSVG + "px")
                .style("right", width  +  "px")
                .style("background", "#fff");

          d3.select(".chart2")
              .on("mousemove", function(){
                 var mousex = d3.mouse(this);
                 mousex = mousex[0] + 5;
                 vertical.style("left", mousex + width/2 + margin.right*2 + margin.left - 5  + "px" )})
              .on("mouseover", function(){
                var mousex = d3.mouse(this);
                 mousex = mousex[0] + 5;
                 vertical.style("left", mousex + width/2 + margin.right*2 + margin.left - 5 + "px" )})
        });
      }

  </script>
</body>

</html>
